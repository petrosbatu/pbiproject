# Дашборд продаж и возвратов в Power BI

### Ссылка на pdf файл: https://github.com/petrosbatu/pbiproject/blob/main/dashboard.pdf 

## Контекст

В сгенерированном датасете имеются данные о продажах некоторой фирмы, а так же по возвратам заказов.

#### Содержание источника данных:

1. Таблица Orders: 
- номер заказа
- данные о клиенте
- класс доставки (в тот же день/первый класс/второй класс/стандартный класс)
- приоритет заказа
- адрес доставки
- даты принятия заказа и его доставки
- прибыль заказа и кол-во товара

2. Таблица Returns:
- статус возвращения (Yes/No)
- номер заказа
- регион заказа

3. Таблица People - не используется

## Постановка задачи

Создать отчёт, который выявляет по каким товарам, способам доставки и другим категориям данных чаще происходят возвраты. Отчёт должен выявить, какие товары сильнее всего влияют на убытки, связанные с возвратами, и на какие из продуктов следует обратить внимание в первую очередь, чтобы снизить частоту возвратов. 

## Шаги создания и описание используемых метрик 

#### Преобразования в Power Query

* Шаг 1 : Загрузка данных из .xslx файла (таблицы **Orders** и **Returns**, далее переименованы в **FactOrders** и **FactReturns**)

* Шаг 2 : Дублируем таблицу FacrOrders и извлекаем из неё столбцы с информацией о покупателях (**CustomerName**, **Segment**). **CustomerID** не используется см. шаг 3. Называем таблицу DimCustomers

* Шаг 3 : В исходных данных у одного покупателя имеется несколько **Customer ID**. 

![multiple_ids](https://github.com/petrosbatu/pbiproject/blob/main/images/Multiple_IDs.jpg?raw=true)

Группируем клиентов по **Customer Name**, **Segment** (категория клиента). Добавляем временный столбец с индексами с первым значением и инкрементом равными 1. Затем с помощью следующей формулы присваем новый **CustomerID**, схожий по своему формату со старыми идентификаторами (первые буквы имени и фамилии и числовое значение c фиксированной длиной и ведущими нулями через дефис).

```powerquery
    Text.Start(Text.BeforeDelimiter([Customer Name], " "), 1) & 
    Text.Start(Text.AfterDelimiter([Customer Name], " "), 1) &
    "-" & Number.ToText([Index], "000000")
```

Получаем таблицу следующего вида:

![dim_customers](https://github.com/petrosbatu/pbiproject/blob/main/images/DimCustomers.jpg?raw=true)

При этом старые значения идентификаторов хранятся в источнике данных и при необходимости могут быть использованны.

* Шаг 4 : Дублируем таблицу **FactOrders** и извлекаем из неё столбцы с информацией о товарах. Сохраняем только уникальные строки (каждый товар мог быть заказан многократно). Получаем таблицу **DimProducts**.

* Шаг 5 : К таблице FactOrders присоединяем таблицу DimCustomers по CustomerName. Из правой таблицы раскрываем столбец **CustomerID**.

* Шаг 6 : Из таблицы заказов убираем те столбцы, которые были перенесены в таблицу измерений (кроме идентификаторов). Также удаляем старый **Customer ID** и другие поля, которые не будут использоватася в дальнейших расчётах и визуализациях.

* Шаг 7 : В таблице **FactReturns** убираем столбец **Returned**, так как в нём все значения равны "Yes" (иначе говоря, в таблице есть записи только о тех заказах, которые были возвращены).

![returned](https://github.com/petrosbatu/pbiproject/blob/main/images/returned.jpg?raw=true)

* Шаг 8 : применяем преобразования power query.

#### Расчёты DAX

* Шаг 9 : Создаём календарь **DimDates** с помощью формулы:

```DAX
DimDates = 
ADDCOLUMNS(
    CALENDARAUTO(),
    "Year", YEAR([Date]),
    "MonthName", FORMAT([Date], "MMMM"),
    "MonthNumber", MONTH([Date]),
    "Day", DAY([Date])
)
```
Устанавливаем сортировку названий месяца по его номеру.

* Шаг 10 : Устанавливаем связи между таблицами.
Таблицы **DimProducts**, **DimCustomers** и **FactReturns** связаны с **FacrOrders** по столбцам с соответсвующими идентификаторами (связь выставлена автоматически). Устанавливаем связь **DimDates** с **FactOrders** по столбцам **Date** и **Order Date**. Также определяем двунаправленную фильтрацию между таблицей заказов и возвратов. Таким образом, фильтры по значениям из таблиц измерений будут фильтровать и таблицу возратов. С другой стороны, можно перебирать значения из таблицы возвратов и доставать значения из таблицы **FactOrders** с соответсвующими **Order ID**.

![model](https://github.com/petrosbatu/pbiproject/blob/main/images/model.jpg?raw=true)  

* Шаг 11 : Добавляем таблицу мер и создаём две меры. 
        
1) **Return Rate** — частота возвратов (в процентах). Определяется как отношение числа заказаов с возвратом к общему числу заказов. При расчёте используется DISTINCT, так как в одном заказе в **FacrOrders** может быть несколько строк, обозначающих разные продукты.       
        
```DAX
        Return Rate = 
        DIVIDE(
            COUNTROWS(FactReturns),
            COUNTROWS( DISTINCT( FactOrders[Order ID]))
        )
```

2) **Loss of profit**  — оценочная величина убытков, связанных с возвратами.
Суммируем все заказы с возвратами, имеющие отрицательную прибыль (умножаем на -1, чтобы получить величину убытков). Многие заказы с возвратами имеют строки с положительной прибылью. Это может быть связано с частичными вовзратами, возвратами за счёт клиента и другими причинами. В любом случае, о величине прибыли в случае успешной сделки ничего не неизвестно (другие столбцы не дают достаточно необходимой информации для расчета этого показателя), кроме того, что она должна по крайней мере быть положительной. Таким образом складывая отрицательные значения, мы гарантируем что убытки от возвратов были не меньше полученного значения.
```DAX
        Loss of profit = -1 *
        SUMX(
            FactReturns,
            SUMX(
                FILTER(
                    RELATEDTABLE(FactOrders),
                    FactOrders[Profit] < 0
                ),
                FactOrders[Profit]
            )
        )
```

#### Визуализации

Замечание: все агрегированные значения вычисляются непосредственно в визуализациях (если для них не создано мер)

* Шаг 13 : устанавливаем тему https://community.fabric.microsoft.com/t5/Themes-Gallery/Simply-Modern-Dark/td-p/2088606

* Шаг 14 : создаём страницу с информацией о продажах. Он содержит ключевые показатели продаж, карту, с иерархией страна -> город. 
![page1](https://github.com/petrosbatu/pbiproject/blob/main/images/dashboard_page-0001.jpg?raw=true) 

Также изображены графики с выручкой по временным отрезкам и с количеством заказов и возвратов по времени. Оба графика имеют иерархию год -> месяц. 

В правом нижнем углу размещено дерево декомпозиции с информацией о прибыли по категориям -> подкатегориям -> товарам. Значения отсортированы по возрастанию прибыли. Таким образом мы в первую очередь видим товары с наименьшей прибылью (в том числе отрицательной). Зная на какие товары обращать внимание, можно анализировать причины убытков или принимать решения о прекращении продаж. 

В верхней части страницы добавлены необходимые фильтры.


* Шаг 15 : создаём страницу с информацией о возвратах. Он содержит ключевые метрики, точечный график с осями **средняя цена доставки** и **Loss of profit** (убытки от возвратов). Каждая точка на графике представлена отдельной подкатегорией. Используются именно подкатегории, так как в одной подкатегории достаточно много продаж, в то время как для каждого товара число продаж  как правило составляет несколько единиц.

![page2](https://github.com/petrosbatu/pbiproject/blob/main/images/dashboard_page-0002.jpg?raw=true) 

Также на странице изображены гистограммы частоты возвратов и средней цены доставки в зависимости от товара (с иерархией категория -> подкатегория -> товар). 

В правом нижнем углу изображена гистограмма комбинированная с линейным графиком. В ней рассматриваются частота возвратов и средняя стоимость доставки в зависимости от сегмента клиента и класса доставки. 

Сверху добавлены фильтры, синхронизированные со страницей о продажах. Таким образом, на каждой странице с помощью визуализаций можно получать какую-то информацию о срезах данных и применяя фильтры сопоставлять с информацией на другой странице.

#### Инсайты

1. Величина убытков от возвратов хоть и не слишком велика, но значительна.

| Profit | Loss of profit |
| --- | --- |
| 1,39 M | 109 K |

2. Число возвратов растёт вместе с числом заказов, которые в свою очередь увеличиваются с каждым годом. 

![returns_by_month](https://github.com/petrosbatu/pbiproject/blob/main/images/returns_by_month.jpg?raw=true)

![profit_by_year](https://github.com/petrosbatu/pbiproject/blob/main/images/profit_by_year.jpg?raw=true)


3. Прибыль также растёт с каждым годом. В перспективе, с ростом продаж компании, оптимизация затрат на возвраты позволит сохранить значительную часть прибыли.

4. Убытки, связанные с возвратами, тем больше, чем больше цена доставки.

![shipcost](https://github.com/petrosbatu/pbiproject/blob/main/images/shipcost.jpg?raw=true)

5. Частота возвратов примерно одинакова для каждой категории, в то время как цена доставки офисных принадлежностей сильно ниже. 

![categories](https://github.com/petrosbatu/pbiproject/blob/main/images/categories.jpg?raw=true)

В это же время офисные принадлежности приносят наибольшую прибыль при наименьших убытках от возвратов. 

| Category | Profit | Loss of profit |
| --- | --- | --- |
| Furniture | 206 K | 39 K |
| Office supplies | 748 K | 32 K |
| Technology | 439 K | 38 K |

6. Средняя цена доставки не различается для различных сегментов клиентов в рамках одного класса доставки. В то же время частота возвратов значительно меняется в рамках одного класса доставки. Особенно заметно это различие для доставки первым классом либо в тот же день.

![segments](https://github.com/petrosbatu/pbiproject/blob/main/images/segment.jpg?raw=true)

Таким образом, можно например предложить различную стоимость заказа для клиентов в зависимости также и от их сегмента.

#### Замечание

Многие срезы данных, полученные после фильтрации, содержат не так много записей в исходных таблицах. Для того чтобы сделать более точные выводы может потребоваться больше данных. Вот так, например выглядит динамика возвратов из Канады.

В целом данный отчет позволяет получить важную информацию на текущем этапе развития компании, однако он расчитан также и на получения дополнительных инсайтов с ростом объема данных.
